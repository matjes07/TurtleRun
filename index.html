<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Turtle Run – Webversion</title>
  <style>
    body { margin: 0; overflow: hidden; background: #1e1e28; }
    canvas { display: block; background: #1e1e28; width:100vw; height:100vh; }
    #ui-overlay { position:absolute; bottom:0; width:100%; height:160px; pointer-events:none; }
    #ui-overlay button {
      position:absolute; width:80px; height:80px;
      font-size:24px; font-weight:bold;
      pointer-events:all; user-select:none;
    }
    #btn-up { left: calc(50% - 100px); bottom:70px; }
    #btn-down { left: calc(50% + 20px); bottom:70px; }
    #btn-special { left: calc(50% + 20px); bottom:10px; }
    #btn-special.cooldown { background: #ccc; color: #666; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="768" height="1024"></canvas>
  <div id="ui-overlay">
    <button id="btn-up">▲</button>
    <button id="btn-down">▼</button>
    <button id="btn-special">POWER</button>
  </div>

  <script>
  // === Assets laden & Spiel starten ===
  const spriteFiles = {
    Standard: ["turtle1.png", "turtle2.png"],
    Blau:     ["käfer1.png", "käfer2.png"],
    Rot:      ["rabbit1.png", "rabbit2.png"],
    Gelb:     ["frog1.png", "frog2.png"],
    Kreis:    ["vogel1.png", "vogel2.png"],
    Dreieck:  ["drache1.png", "drache2.png"],
    Chaser:   ["dino1.png", "dino2.png"],
    Coin:     ["coin1.png", "coin2.png"],
    Block:    ["block1.png"],
    Background:["background.png"]
  };
  const images = {};
  let loaded=0, total=0;
  for (let key in spriteFiles) total += spriteFiles[key].length;
  for (let key in spriteFiles) {
    images[key]=[];
    spriteFiles[key].forEach(src=>{
      const img=new Image();
      img.src=src;
      img.onload=()=>{ if(++loaded===total) init(); };
      images[key].push(img);
    });
  }
  const coinSound=new Audio("coin.mp3");
  const bgMusic=new Audio("backgroundMusic.mp3");
  bgMusic.loop=true;
  bgMusic.volume=0.5;

  function init(){
    bgMusic.play().catch(err=>{});
    setup();
    requestAnimationFrame(loop);
  }

  // === Spielvariablen & Setup ===
  const canvas=document.getElementById("gameCanvas");
  const ctx=canvas.getContext("2d");
  const WIDTH=canvas.width, HEIGHT=canvas.height;
  let coins, blocks, projectiles, player, chaser;
  let coinTimer, blockTimer, gameTime, score, coinCount;
  let level, levelTimer, specialCooldown, specialActive, specialActiveTimer, projectileDelay;
  let animTimer, animFrame, gameState;
  let selectedSkin, skins;

  function setup(){
    coins=[]; blocks=[]; projectiles=[];
    coinTimer=0; blockTimer=0; gameTime=0; score=0; coinCount=0;
    level=1; levelTimer=0; specialCooldown=0;
    specialActive=false; specialActiveTimer=0; projectileDelay=null;
    animTimer=0; animFrame=0; gameState="start";
    player={x:100,y:HEIGHT/2,w:40,h:40,speed:4,baseSpeed:4,vy:0};
    chaser={x:50,y:HEIGHT/2,w:40,h:40,speed:2.5};

    skins=[
      {name:"Standard",cost:0,owned:true},
      {name:"Blau",cost:10,owned:false},
      {name:"Rot",cost:25,owned:false},
      {name:"Gelb",cost:40,owned:false},
      {name:"Kreis",cost:65,owned:false},
      {name:"Dreieck",cost:111,owned:false}
    ];
    selectedSkin=skins[0];

    // Input
    document.getElementById("btn-up").onpointerdown=()=>{ player.vy=player.speed; };
    document.getElementById("btn-down").onpointerdown=()=>{ player.vy=-player.speed; };
    document.getElementById("btn-up").onpointerup=()=>{ player.vy=0; };
    document.getElementById("btn-down").onpointerup=()=>{ player.vy=0; };
    document.getElementById("btn-special").onpointerdown=activateSpecial;
    canvas.onclick=ev=>{
      if(gameState==="start"||gameState==="gameover"){
        if(gameState==="start") gameState="playing";
        else setup();
      }
    };
  }

  // === Hauptschleife ===
  function loop(ts){
    const dt=0.016;
    update(dt); draw();
    requestAnimationFrame(loop);
  }

  function update(dt){
    if(gameState==="playing"){
      gameTime+=dt; score=Math.floor(gameTime*10);
      coinTimer+=dt; blockTimer+=dt; levelTimer+=dt;
      if(blockTimer>Math.max(0.4,1.5-(level-1)*0.15)){
        blockTimer=0;
        const spawns=(level>=3?Math.min(3,level-2):0)+1;
        for(let i=0;i<spawns;i++){
          blocks.push({x:player.x+WIDTH+i*70,y:Math.random()*(HEIGHT-280)+160,w:60,h:60});
        }
      }
      if(coinTimer>Math.max(0.8,2.5-(level-1)*0.2)){
        coinTimer=0;
        coins.push({x:player.x+WIDTH,y:Math.random()*(HEIGHT-280)+160,r:20,magnetTime:0,tx:0,ty:0});
      }

      blocks=blocks.filter(b=>{
        b.x-=4;
        if(collide(player,b)){
          player.x=Math.min(player.x,b.x-player.w);
        }
        return b.x+b.w>player.x-WIDTH;
      });

      coins=coins.filter(c=>{
        if(c.magnetTime>0){
          c.magnetTime-=dt;
          c.x+=(player.x+player.w/2-c.x)*0.1;
          c.y+=(player.y+player.h/2-c.y)*0.1;
        } else c.x-=4;
        if(dist(player.x+player.w/2,player.y+player.h/2,c.x,c.y)<c.r+player.w/2){
          coinCount++; coinSound.currentTime=0; coinSound.play();
          return false;
        }
        return c.x+c.r>player.x-WIDTH;
      });

      projectiles=projectiles.filter(p=>{
        p.x+=p.speed;
        for(let i=blocks.length-1;i>=0;i--){
          const b=blocks[i];
          if(p.x>b.x && p.x<b.x+b.w && p.y>b.y && p.y<b.y+b.h){
            blocks.splice(i,1); return false;
          }
        }
        return p.x<player.x+WIDTH;
      });

      if(!blocks.some(b=>collide(player,b))) player.x+=1.5;
      player.y=Math.max(160,Math.min(HEIGHT-60-player.h,player.y+player.vy));
      const dx=player.x-60-chaser.x, dy=player.y-chaser.y;
      const d=Math.hypot(dx,dy);
      if(d>1){ chaser.x+=dx/d*chaser.speed; chaser.y+=dy/d*chaser.speed; }
      if(!specialActive && collide(player,chaser)) gameState="gameover";

      if(specialActive){
        specialActiveTimer-=dt;
        if(specialActiveTimer<=0){ specialActive=false; player.speed=player.baseSpeed; }
      }

      if(projectileDelay!==null){
        projectileDelay-=dt;
        if(projectileDelay<=0){ shootProjectile(); projectileDelay=null; }
      }

      if(levelTimer>=30){
        levelTimer=0; level++;
        chaser.speed+=0.6; player.speed+=0.3;
      }

      animTimer+=dt;
      if(animTimer>0.2){ animTimer=0; animFrame^=1; }
    }
  }

  function draw(){
    ctx.clearRect(0,0,WIDTH,HEIGHT);
    if(gameState==="start"){
      drawStart(); return;
    } else if(gameState==="gameover"){
      drawGameOver(); return;
    }
    // Camera
    ctx.save(); ctx.translate(-player.x+WIDTH/5,0);
    // Hintergrund
    const bg=images.Background[0];
    const bgW=1000, bgH=HEIGHT*1.9;
    const off= (player.x*1.8)%bgW;
    for(let i=-1;i<5;i++){
      ctx.globalAlpha=0.63;
      ctx.drawImage(bg, i*bgW-off,0,bgW,bgH);
    }
    ctx.globalAlpha=1;
    // Blocks
    blocks.forEach(b=> ctx.drawImage(images.Block[0],b.x,b.y,b.w,b.h));
    // Coins
    coins.forEach(c=> ctx.drawImage(images.Coin[animFrame],c.x-20,c.y-20,40,40));
    // Projectiles
    projectiles.forEach(p=> ctx.drawImage(images.Coin[0],p.x-10,p.y-10,20,20));
    // Spieler
    const skinArr=images[selectedSkin.name];
    ctx.drawImage(skinArr[animFrame],player.x,player.y,player.w,player.h);
    // Chaser
    ctx.drawImage(images.Chaser[animFrame],chaser.x,chaser.y,chaser.w,chaser.h);
    ctx.restore();

    // UI
    ctx.fillStyle="#222"; ctx.fillRect(0,HEIGHT-60,WIDTH,60);
    ctx.fillRect(0,0,WIDTH,160);
    ctx.fillStyle="#fff"; ctx.font="26px sans-serif";
    ctx.fillText("Punkte: "+score,WIDTH/3,HEIGHT-30);
    ctx.fillStyle="#FFD"; ctx.fillText("Münzen: "+coinCount,WIDTH/2,HEIGHT-70);
    ctx.fillStyle="#fff"; ctx.font="24px sans-serif";
    ctx.fillText("Level: "+level,WIDTH-60,HEIGHT-30);

    const btn=document.getElementById("btn-special");
    if(specialCooldown>0){
      specialCooldown-=0.016;
      btn.classList.add("cooldown");
      btn.textContent=`POWER (${Math.ceil(specialCooldown)}s)`;
    } else {
      btn.classList.remove("cooldown");
      btn.textContent="POWER";
    }
  }

  function drawStart(){
    ctx.fillStyle="#fff"; ctx.font="44px sans-serif";
    ctx.textAlign="center";
    ctx.fillText("TURTLE RUN",WIDTH/2,HEIGHT/2);
    ctx.font="24px sans-serif";
    ctx.fillText("Klick/Tippe, um zu starten",WIDTH/2,HEIGHT/2+40);
  }
  function drawGameOver(){
    ctx.fillStyle="#fff"; ctx.font="44px sans-serif";
    ctx.textAlign="center";
    ctx.fillText("GAME OVER",WIDTH/2,HEIGHT/2);
    ctx.fillText("Punkte: "+score,WIDTH/2,HEIGHT/2+60);
    ctx.fillText("Münzen: "+coinCount,WIDTH/2,HEIGHT/2+100);
  }

  function collide(a,b){
    return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
  }
  function dist(x1,y1,x2,y2){
    return Math.hypot(x1-x2,y1-y2);
  }

  function activateSpecial(){
    if(specialCooldown>0||gameState!=="playing") return;
    specialCooldown=6;
    const p=selectedSkin.name;
    if(p==="Blau"){
      player.speed=7; specialActive=true; specialActiveTimer=3;
    } else if(p==="Rot"){
      specialActive=true; specialActiveTimer=3;
    } else if(p==="Gelb"||p==="Kreis"){
      const t=(p==="Gelb"?2.5:4);
      coins.forEach(c=>{
        c.magnetTime=t; c.tx=player.x+player.w/2; c.ty=player.y+player.h/2;
      });
    } else if(p==="Dreieck"){
      shootProjectile();
      projectileDelay=0.5;
    }
  }

  function shootProjectile(){
    projectiles.push({
      x:player.x+player.w,
      y:player.y+player.h/2,
      r:10, speed:6
    });
  }
  </script>
</body>
</html>